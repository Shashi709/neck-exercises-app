<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Neck Exercises Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#2563eb">
  <meta name="description" content="Admin panel for neck exercises with sequencer control">
  <style>
    html, body {
      font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
      background: #f6f8fa;
      margin:0; padding:0;
      min-height: 100%;
      color: #21232a;
      letter-spacing: 0.01em;
    }
    *, *:before, *:after { box-sizing: border-box; }

    h1 {
      text-align:center;
      color: #223366;
      margin:36px 0 18px 0;
      font-size:2.07em;
      font-weight: 800;
      letter-spacing: 0.05em;
      text-shadow: 0 1.5px 0 #e3e7ee;
    }

    .container {
      max-width:700px;
      margin:auto;
      padding:18px 10px 32px 10px;
    }

    .section-head {
      margin:38px 0 18px 0;
      font-size:1.14em;
      font-weight: 600;
      color:#4a6078;
      background: #fff;
      border-radius: 15px;
      box-shadow: 0 1px 4px #c8d0db13;
      padding: 8px 18px;
      border: 1px solid #e5e9f1;
      position: relative;
    }

    .exercise-box {
      background: #fff;
      border-radius: 20px;
      box-shadow: 0 6px 32px 0 #dde2ec40, 0 1px 2px #d9dee9;
      margin-bottom: 30px;
      padding: 28px 22px 20px 22px;
      position:relative;
      border: 1px solid #e5e9f1;
      transition: box-shadow 0.18s, border 0.16s;
    }
    .exercise-box.active {
      box-shadow: 0 10px 42px #c4cee355, 0 1.5px 6px #b8c9df42;
      border-color: #bccbe6;
    }

    .ex-header {
      display:flex; align-items:flex-start;
      margin-bottom:13px; gap:16px;
    }
    .ex-icon {
      min-width:56px; min-height:56px;
      width:56px; height:56px;
      background: #f5f7fb;
      border-radius: 10px;
      display:flex; align-items:center; justify-content:center;
      font-size:2.2em; flex-shrink:0; margin-top:2px;
      box-shadow: 0 1.5px 10px #e6eaf7, 0 2px 4px #f5f7fa inset;
      border: 1.5px solid #f1f4fa;
      transition: box-shadow 0.12s, border 0.15s;
    }
    .exercise-box.active .ex-icon {
      box-shadow: 0 3px 20px #c6d4ec80;
      border-color: #dde8f8;
    }

    .ex-content { flex:1;}
    .ex-title {
      font-weight:700;
      font-size:1.10em;
      color:#223366;
      margin-bottom:4px;
    }
    .ex-desc {
      color:#5a6271;
      font-size:1em;
      margin:5px 0 0 0;
      font-weight:400;
      line-height:1.52;
      letter-spacing:0.01em;
    }

    .inputs-row {
      margin:13px 0 8px 0;
      display:flex;
      gap:16px;
      align-items:stretch;
      flex-wrap:wrap;
    }
    label {
      font-size:0.99em;
      color:#425375;
      font-weight:500;
      display:flex;
      align-items:center;
      gap:6px;
      flex:1;
      min-width:140px;
    }
    input[type='number'] {
      width:100%;
      max-width:70px;
      padding:8px 12px;
      font-size:1em;
      border-radius:7px;
      border:1.3px solid #d2d9e7;
      background: #f8fafc;
      color:#223355;
      font-weight:600;
      box-shadow: 0 2px 7px #f4f7fa05;
      outline:none;
      transition: border 0.18s, box-shadow 0.17s;
    }
    input[type='number']:focus {
      border:2px solid #a1b4de;
      background: #fff;
    }
    input[type='number']:disabled {
      background: #f3f6fb;
      color: #a5aab3;
      border-color: #ebf0f8;
    }

    .btn-row {
      display:flex; gap:9px;
      margin-top:12px;
      flex-wrap:wrap;
    }
    button {
      padding:9px 23px;
      font-size:1.03em;
      border-radius:11px;
      border:none;
      font-weight:700;
      cursor:pointer;
      background: #f4f7fb;
      color:#2a3350;
      border: 1.2px solid #e5e9f1;
      box-shadow: 0 1.5px 8px #dde3ef20;
      transition: background 0.18s, box-shadow 0.15s, color 0.13s, border 0.14s, transform 0.12s;
    }
    button:hover, button:focus {
      background: #e9eef6;
      color: #003366;
      border-color: #c9d2e3;
      box-shadow: 0 4px 18px #ccd6e420;
    }
    button:active {
      background: #e0e8f2;
      color: #18223b;
      transform: scale(0.98);
    }
    .start {font-weight:800;}
    .pause {color:#aa7600;}
    .resume {color:#18604b;}
    .reset {color:#a43939;}
    button:disabled {
      background: #f3f5f9;
      color: #c5c7cb;
      cursor: not-allowed;
      border-color: #f3f5fa;
      box-shadow: none;
    }

    .counter-row {
      display:flex; gap:14px; align-items:center;
      margin:13px 0 2px 0; flex-wrap:wrap;
      font-size:1em;
    }
    .big-num {
      font-size:1.22em;
      color:#234288;
      min-width:28px;
      display:inline-block;
      font-weight:700;
    }
    .active .big-num,
    .big-num.pulse {
      color:#3063b1;
    }
    .total-time {
      font-size:0.97em;
      color:#57647d;
      background: #f4f6fa;
      padding: 3px 10px;
      border-radius: 6px;
      font-weight: 600;
      box-shadow: 0 0 7px #dce5f33b;
      border: 1.1px solid #e5eaf4;
      margin-left:4px;
    }

    .progress-txt {
      font-size:1.01em;
      font-weight:600;
      color:#397857;
      margin-top:8px;
      min-height: 16px;
      letter-spacing: 0.01em;
      padding-left: 2px;
    }
    .danger {
      color:#d94343;
      background: #f8f2f2;
      border-radius: 7px;
      padding: 7px 11px 6px 11px;
      font-weight:700;
      box-shadow: 0 0 12px #f2d0d0;
      margin-bottom: 15px;
      display:inline-block;
      border: 1.1px solid #efdddd;
      letter-spacing: 0.03em;
    }
    .warning {color:#ad7b0c;}
    .progress-txt.danger {animation: shake 0.35s 1;}
    .progress-txt.warning {animation: flashWarn 0.5s 1;}

    @keyframes shake {
      20% {transform: translateX(-4px);}
      40% {transform: translateX(5px);}
      60% {transform: translateX(-3px);}
      80% {transform: translateX(2px);}
      100% {transform: translateX(0);}
    }
    @keyframes flashWarn {
      0% {color:#eaaa13;}
      80% {color:#ad7b0c;}
      100% {color:#ad7b0c;}
    }
    .big-num.pulse {
      animation: pulseGrow 0.16s cubic-bezier(.57,.24,.77,1.36);
    }
    @keyframes pulseGrow {
      0% { transform: scale(1);}
      50% { transform: scale(1.15);}
      100% { transform: scale(1);}
    }

    @media (max-width: 900px){
      h1 {font-size: 1.5em; margin:20px 0 12px 0;}
      .container{padding:12px 12px 24px 12px; max-width:100%;}
      .section-head{font-size: 1.05em; padding: 10px 14px; margin:24px 0 14px 0;}
      .exercise-box{padding:16px 14px 14px 14px; margin-bottom:20px; border-radius:16px;}
      .ex-header{gap:12px;}
      .ex-icon{width:48px;min-width:48px;height:48px;min-height:48px;font-size:1.8em; margin-top:0;}
      .ex-title{font-size:1.05em;}
      .ex-desc{font-size:0.95em; line-height:1.45;}
      .inputs-row{gap:10px; margin:12px 0 10px 0;}
      label{font-size:0.95em; min-width:130px;}
      input[type='number']{padding:6px 8px; font-size:0.95em; max-width:65px;}
      .btn-row{gap:7px; margin-top:10px;}
      button{padding:8px 18px; font-size:0.98em; border-radius:9px;}
      .counter-row{gap:10px; margin:12px 0 6px 0; font-size:0.95em;}
      .big-num{font-size:1.15em; min-width:24px;}
      .total-time{font-size:0.92em; padding:2px 8px; border-radius:5px;}
      .sequencer-panel{margin:60px auto 16px auto; padding:12px;}
      .sequencer-panel .btn-row button{padding:7px 12px; font-size:0.9em;}
      .theme-toggle{top:8px; right:8px;}
      .theme-toggle button{padding:4px 8px; font-size:0.8em;}
    }
    @media (max-width: 750px){
      .exercise-box{padding:12px 10px 10px 10px; margin-bottom:16px;}
      .ex-header{flex-direction:column; gap:8px;}
      .ex-icon{width:44px; min-width:44px; height:44px; min-height:44px; font-size:1.6em;}
      .ex-title{font-size:1em;}
      .ex-desc{font-size:0.88em;}
      .inputs-row{gap:8px; margin:10px 0 8px 0; flex-direction:column;}
      label{font-size:0.9em; min-width:100%; display:flex; justify-content:space-between; align-items:center;}
      input[type='number']{max-width:100%; padding:7px 10px; font-size:0.9em; flex:0 0 auto; width:70px;}
      .btn-row{gap:5px; margin-top:8px;}
      .btn-row button{font-size:0.88em; padding:6px 12px; flex:1;}
      .counter-row{gap:6px; margin:10px 0 4px 0; font-size:0.86em; flex-wrap:wrap;}
      .big-num{font-size:1.08em; min-width:22px;}
      .total-time{font-size:0.85em; padding:2px 6px;}
      .progress-txt{font-size:0.92em; margin-top:5px;}
      .sequencer-panel{margin:50px auto 14px auto; padding:10px; border-radius:12px;}
      .sequencer-panel .section-head{font-size:0.9em; padding:6px 10px; margin:0 0 8px 0;}
      .sequencer-panel .btn-row{gap:6px; margin-top:8px;}
      .sequencer-panel .btn-row button{padding:6px 10px; font-size:0.85em;}
    }
    @media (max-width: 600px){
      h1 {font-size: 1.25em; margin:16px 0 10px 0;}
      .container{padding:10px 10px 18px 10px;}
      .section-head{font-size: 0.95em; padding: 8px 12px; margin:18px 0 12px 0;}
      .exercise-box{padding:10px 9px 8px 9px; margin-bottom:14px; border-radius:12px;}
      .ex-icon{width:40px; min-width:40px; height:40px; min-height:40px; font-size:1.5em;}
      .ex-title{font-size:0.98em;}
      .ex-desc{font-size:0.85em; line-height:1.35;}
      .inputs-row{gap:6px; margin:8px 0 6px 0; flex-direction:column;}
      label{font-size:0.88em; justify-content:space-between; min-width:100%;}
      input[type='number']{width:65px; padding:6px 8px; font-size:0.88em;}
      .btn-row{gap:4px; margin-top:6px;}
      .btn-row button{font-size:0.84em; padding:5px 10px; flex:1; min-height:32px;}
      .counter-row{gap:5px; margin:8px 0 3px 0; font-size:0.82em; flex-wrap:wrap;}
      .big-num{font-size:1.05em; min-width:20px;}
      .total-time{font-size:0.8em; padding:1px 5px;}
      .progress-txt{font-size:0.88em; margin-top:4px;}
      .danger{padding:5px 8px 4px 8px; font-size:0.85em; margin-bottom:10px;}
      .sequencer-panel{margin:45px auto 12px auto; padding:8px; border-radius:10px;}
      .sequencer-panel .section-head{font-size:0.85em; padding:5px 8px; margin:0 0 6px 0;}
      .sequencer-panel .btn-row{gap:4px; margin-top:6px;}
      .sequencer-panel .btn-row button{padding:5px 8px; font-size:0.8em; flex:1;}
      .theme-toggle{top:5px; right:5px; gap:4px;}
      .theme-toggle button{padding:3px 6px; font-size:0.72em; border-radius:5px;}
    }
    @media (max-width: 480px){
      html, body{font-size:13px;}
      h1 {font-size: 1.1em; margin:12px 0 8px 0;}
      .container{padding:8px 8px 14px 8px;}
      .section-head{font-size: 0.88em; padding: 6px 10px; margin:14px 0 10px 0; border-radius:9px;}
      .exercise-box{padding:8px 8px 6px 8px; margin-bottom:12px; border-radius:10px;}
      .ex-header{gap:8px;}
      .ex-icon{width:36px; min-width:36px; height:36px; min-height:36px; font-size:1.3em;}
      .ex-title{font-size:0.95em; font-weight:700;}
      .ex-desc{font-size:0.82em; line-height:1.32; margin:2px 0 0 0;}
      .inputs-row{gap:5px; margin:6px 0 4px 0; flex-direction:column;}
      label{font-size:0.85em; font-weight:500; justify-content:space-between; gap:4px;}
      input[type='number']{width:60px; padding:5px 7px; font-size:0.85em; border-radius:5px;}
      input[type='number']:disabled {background: #f3f6fb; color: #a5aab3; border-color: #ebf0f8; }
      .btn-row{gap:3px; margin-top:5px; flex-wrap:wrap;}
      .btn-row button{font-size:0.8em; padding:4px 8px; border-radius:6px; flex:1; min-width:60px; min-height:30px;}
      .counter-row{gap:4px; margin:6px 0 2px 0; font-size:0.78em; flex-wrap:wrap;}
      .big-num{font-size:1.02em; min-width:18px;}
      .total-time{font-size:0.76em; padding:1px 4px; border-radius:3px; margin-left:2px;}
      .progress-txt{font-size:0.84em; margin-top:3px; min-height:13px;}
      .danger{padding:4px 6px 3px 6px; font-size:0.78em; border-radius:4px; margin-bottom:8px;}
      .warning{font-size:0.84em;}
      .sequencer-panel{margin:40px auto 10px auto; padding:6px; border-radius:8px;}
      .sequencer-panel .section-head{font-size:0.8em; padding:4px 6px; margin:0 0 4px 0;}
      .sequencer-panel .btn-row{gap:2px; margin-top:4px;}
      .sequencer-panel .btn-row button{padding:4px 6px; font-size:0.75em; flex:1;}
      .sequencer-status{font-size:0.78em; padding:4px; margin-top:4px;}
      .theme-toggle{top:4px; right:4px; gap:2px;}
      .theme-toggle button{padding:2px 5px; font-size:0.65em; border-radius:4px; border:1px solid #999;}
    }
    @media (max-width: 380px){
      h1 {font-size: 1em; margin:10px 0 6px 0;}
      .container{padding:6px 6px 10px 6px;}
      .section-head{font-size: 0.82em; padding: 5px 8px; margin:10px 0 8px 0; border-radius:8px;}
      .exercise-box{padding:6px 6px 4px 6px; margin-bottom:10px; border-radius:8px;}
      .ex-header{gap:6px;}
      .ex-icon{width:32px; min-width:32px; height:32px; min-height:32px; font-size:1.1em;}
      .ex-title{font-size:0.9em; margin-bottom:2px;}
      .ex-desc{font-size:0.78em; line-height:1.3; margin:1px 0 0 0;}
      .inputs-row{gap:4px; margin:5px 0 3px 0;}
      label{font-size:0.8em; justify-content:space-between;}
      input[type='number']{width:55px; padding:4px 6px; font-size:0.8em; border-radius:4px;}
      .btn-row{gap:2px; margin-top:4px;}
      .btn-row button{font-size:0.75em; padding:3px 6px; min-width:50px; min-height:28px;}
      .counter-row{gap:3px; margin:5px 0 1px 0; font-size:0.74em;}
      .big-num{font-size:0.98em; min-width:16px;}
      .total-time{font-size:0.72em; padding:0px 3px; margin-left:1px;}
      .progress-txt{font-size:0.8em; margin-top:2px; min-height:12px;}
      .danger{padding:3px 5px; font-size:0.74em; margin-bottom:6px;}
      .sequencer-panel{margin:35px auto 8px auto; padding:4px; border-radius:6px;}
      .sequencer-panel .section-head{font-size:0.75em; padding:3px 5px;}
      .sequencer-panel .btn-row button{padding:3px 4px; font-size:0.7em;}
      .theme-toggle{top:3px; right:3px; gap:2px;}
      .theme-toggle button{padding:2px 4px; font-size:0.6em; border-radius:3px;}
    }}
      .counter-row{font-size:0.75em; gap:4px; margin:6px 0 2px 0;}
      .big-num{font-size:1em; min-width:18px;}
      .total-time{font-size:0.75em; padding:1px 4px;}
      .sequencer-panel{margin:40px auto 10px auto; padding:6px;}
      .sequencer-panel .section-head{font-size:0.8em; padding:4px 6px;}
      .sequencer-panel .btn-row button{padding:4px 6px; font-size:0.75em;}
    }
    /* Dark mode overrides */
    body.dark-mode {
      background: #07101a;
      color: #dbe9ff;
    }
    body.dark-mode .section-head{
      background: #071826;
      color: #bfd9ff;
      border-color: #173043;
      box-shadow: none;
    }
    body.dark-mode .exercise-box{
      background: #08121a;
      border-color: #123042;
      box-shadow: none;
      color: #dbe9ff;
    }
    body.dark-mode .ex-icon{ background: #06202b; border-color: #163242; box-shadow:none; }
    body.dark-mode input[type='number']{ background:#06121a; color:#dbe9ff; border-color:#214055; }
    body.dark-mode button{ background:#0b2a3a; color:#d4ecff; border-color:#143241; box-shadow:none; }
    body.dark-mode .total-time{ background:#081623; color:#bcd6ef; border-color:#1b3346; }
    body.dark-mode .progress-txt{ color:#9fe0b1; }
    body.dark-mode .danger{ background:#3b1212; color:#ffd6d6; border-color:#5a1b1b; box-shadow:none; }
    body.dark-mode input[type='checkbox']{ accent-color:#5ba3d0; }
    .sel-ex-label { display:flex; align-items:center; gap:8px; padding:6px 12px; background:#f0f7f0; border-radius:6px; border:1px solid #c8e6c9; cursor:pointer; font-weight:600; color:#2e7d32; flex-shrink:0; }
    body.dark-mode .sel-ex-label { background:#1a3a1a; border-color:#3a6a3a; color:#66bb6a; }
    .theme-toggle{ position:fixed; top:10px; right:10px; z-index:999; display:flex; gap:6px; }
    .theme-toggle button{ padding:5px 10px; border-radius:7px; font-weight:600; cursor:pointer; font-size:0.85em; }
    .sequencer-panel {
      max-width:700px; margin:100px auto 20px auto; background:#fff; border-radius:15px; border:1px solid #e5e9f1; padding:16px; box-shadow: 0 1px 4px #c8d0db13;
    }
    body.dark-mode .sequencer-panel { background:#08121a; border-color:#123042; }
    .sequencer-panel .btn-row { gap:8px; flex-wrap:wrap; }
    .sequencer-panel .btn-row button { padding:8px 16px; font-size:0.96em; }
    .sequencer-status { margin-top:12px; padding:10px; background:#f0f7f0; border-radius:8px; border:1px solid #c8e6c9; color:#2e7d32; font-weight:600; display:none; }
    body.dark-mode .sequencer-status { background:#1a3a1a; border-color:#3a6a3a; color:#66bb6a; }
    input[type='checkbox'] { margin-right:6px; cursor:pointer; }
  </style>
</head>
<body>
  <h1>Neck Exercises Admin</h1>
  <div class="theme-toggle">
    <button id="themeToggle" aria-pressed="false" title="Toggle dark mode">üåô</button>
    <button id="backBtn" title="Go back to Exercises" style="background:#7c3aed; color:#fff;">‚Üê Back</button>
  </div>
  
  <!-- Sequencer Panel -->
  <div class="sequencer-panel">
    <div class="section-head">‚ö° Sequencer - Auto Run All Exercises</div>
    <div class="btn-row" style="gap:10px; flex-wrap:wrap; margin-top:12px;">
      <button id="selectAllBtn" style="background:#e3f2fd; color:#1976d2;">‚úì Select All</button>
      <button id="deselectAllBtn" style="background:#fce4ec; color:#c2185b;">‚úó Deselect All</button>
      <button id="startAllBtn" style="background:#e8f5e9; color:#388e3c; font-weight:800;">‚ñ∂ Start All</button>
      <button id="pauseAllBtn" style="background:#fff3e0; color:#f57c00;">‚è∏ Pause All</button>
      <button id="resumeAllBtn" style="background:#e0f2f1; color:#00796b;">‚ñ∂ Resume All</button>
      <button id="resetAllBtn" style="background:#ffebee; color:#d32f2f;">‚ü≤ Reset All</button>
    </div>
    <div class="sequencer-status" id="seqStatus">Running... Next: --</div>
  </div>

  <div class="container" id="exerciseContainer">
    <div style="margin:16px 0 12px 0; text-align:center;">
      <span class="danger">If you experience any pain, STOP exercising immediately!</span>
    </div>
  </div>
  <!-- Audio with inline data -->
  <audio id="beep-sound" preload="auto"></audio>
  <audio id="start-sound" preload="auto"></audio>
  <audio id="first-time-sound" preload="auto"></audio>
<script>
// --- Register Service Worker for offline caching ---
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/service-worker.js').then(() => {
    console.log('Service Worker registered successfully');
  }).catch((error) => {
    console.log('Service Worker registration failed:', error);
  });
}

// --- Theme toggle (dark mode) ---
(function(){
  const themeToggle = document.getElementById('themeToggle');
  function applyTheme(t){
    if(t==='dark'){
      document.body.classList.add('dark-mode');
      themeToggle.setAttribute('aria-pressed','true');
      themeToggle.textContent = '‚òÄÔ∏è';
    } else {
      document.body.classList.remove('dark-mode');
      themeToggle.setAttribute('aria-pressed','false');
      themeToggle.textContent = 'üåô';
    }
  }
  if(themeToggle){
    themeToggle.addEventListener('click', ()=>{
      const next = document.body.classList.contains('dark-mode') ? 'light' : 'dark';
      applyTheme(next);
      try{ localStorage.setItem('neck_theme', next); }catch(e){}
    });
    const stored = (()=>{ try{return localStorage.getItem('neck_theme')}catch(e){return null} })();
    if(stored) applyTheme(stored);
    else if(window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) applyTheme('dark');
    else applyTheme('light');
  }
})();

// --- Back button ---
document.getElementById('backBtn').addEventListener('click', ()=>{
  window.location.href = 'index.html';
});

const exerciseSections = [
  {
    title: "Warm-up Exercises",
    exercises: [
      {
        name: "Neck Rotation",
        icon: "üîÑ",
        description: "Slowly turn your head left and right. Don't force, stay gentle.",
        defaultReps: 20, defaultSeconds: 12
      },
      {
        name: "Neck Side Bending",
        icon: "‚ÜîÔ∏è",
        description: "Slowly bend your head so your ear moves towards shoulder (left/right). Shoulders relaxed.",
        defaultReps: 20, defaultSeconds: 12
      }
    ]
  },
  {
    title: "Strengthening Exercises",
    exercises: [
      {
        name: "Front + Back Neck Isometric",
        icon: "üßë‚Äçü¶±‚úã‚ÜîÔ∏è",
        description: "Alternate: Push forehead into hands (front), then push back of head into hands (back), hold. 1 rep = front + back.",
        defaultReps: 20, defaultSeconds: 12
      },
      {
        name: "Side Neck Isometric (Left + Right)",
        icon: "<span>üßëü§ö</span><span style='margin-left:-6px;'>ü§öüßë</span>",
        description: "Place hand on left side of head. Push head against hand (no movement), then switch to right side. <br>1 rep = both sides.",
        defaultReps: 20, defaultSeconds: 12
      },
      {
        name: "Shoulder Shrugs",
        icon: "ü§∑",
        description: "Move your shoulders up towards your ears, then relax to original position.",
        defaultReps: 20, defaultSeconds: 12
      },
      {
        name: "Arm Swinging",
        icon: "üí™‚ÜîÔ∏è",
        description: "Move your arms forward and backward as shown (see picture/guide if unsure).",
        defaultReps: 8, defaultSeconds: 10
      }
    ]
  }
];

// --- Beep logic ---
const beep = document.getElementById('beep-sound');
const startSound = document.getElementById('start-sound');
const firstTimeSound = document.getElementById('first-time-sound');

// Create simple beep tones programmatically
function createBeepAudio() {
  const audioContext = new (window.AudioContext || window.webkitAudioContext)();
  const oscillator = audioContext.createOscillator();
  const gainNode = audioContext.createGain();
  oscillator.connect(gainNode);
  gainNode.connect(audioContext.destination);
  oscillator.frequency.value = 800;
  gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
  gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
  oscillator.start(audioContext.currentTime);
  oscillator.stop(audioContext.currentTime + 0.1);
}

function createStartAudio() {
  try {
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    oscillator.frequency.setValueAtTime(600, audioContext.currentTime);
    oscillator.frequency.linearRampToValueAtTime(900, audioContext.currentTime + 0.2);
    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
    oscillator.start(audioContext.currentTime);
    oscillator.stop(audioContext.currentTime + 0.2);
  } catch(e) {}
}

function createFirstTimeAudio() {
  try {
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    oscillator.frequency.setValueAtTime(1200, audioContext.currentTime);
    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);
    oscillator.start(audioContext.currentTime);
    oscillator.stop(audioContext.currentTime + 0.15);
  } catch(e) {}
}

let audioUnlocked = false;
function unlockAudio() {
  if (!audioUnlocked) {
    try {
      createBeepAudio();
    } catch(e) {}
    audioUnlocked = true;
  }
}
document.addEventListener('click', unlockAudio);
document.addEventListener('touchstart', unlockAudio);

function playBeep(repeats) {
  let played = 0;
  const interval = setInterval(() => {
    try {
      createBeepAudio();
    } catch(e) {}
    played++;
    if (played >= repeats) clearInterval(interval);
  }, 250);
}

function playStartSound() {
  try {
    createStartAudio();
  } catch(e) {}
}

function playFirstTimeSound() {
  try {
    createFirstTimeAudio();
  } catch(e) {}
}

function formatTime(secs) {
  let m = Math.floor(secs/60), s = secs%60;
  return `${m}:${s<10?'0':''}${s}`;
}

const exContainer = document.getElementById('exerciseContainer');
const controllers = [];

exerciseSections.forEach((sec, secIdx) => {
  const sectionHead = document.createElement('div');
  sectionHead.className = "section-head";
  sectionHead.textContent = sec.title;
  exContainer.appendChild(sectionHead);

  sec.exercises.forEach((ex, idx) => {
    const exBox = document.createElement('div');
    exBox.className = "exercise-box";
    let iconHTML = ex.icon.startsWith('<span') ? ex.icon : `<span>${ex.icon}</span>`;
    exBox.innerHTML = `
      <div class="ex-header">
        <div class="ex-icon">${iconHTML}</div>
        <div class="ex-content">
          <div class="ex-title">${ex.name}</div>
          <div class="ex-desc">${ex.description}</div>
        </div>
      </div>
      <div class="inputs-row">
        <label class="sel-ex-label">
          <input type="checkbox" class="sel-ex" id="sel_${secIdx}_${idx}" checked> ‚úì Select
        </label>
        <label>Reps:
          <input type="number" min="1" max="99" value="${ex.defaultReps}" id="reps_${secIdx}_${idx}">
        </label>
        <label>Time/Rep (sec):
          <input type="number" min="1" max="99" value="${ex.defaultSeconds}" id="seconds_${secIdx}_${idx}">
        </label>
      </div>
      <div class="btn-row">
        <button class="start"    id="start_${secIdx}_${idx}">Start</button>
        <button class="pause"    id="pause_${secIdx}_${idx}" style="display:none;">Pause</button>
        <button class="resume"   id="resume_${secIdx}_${idx}" style="display:none;">Resume</button>
        <button class="reset"    id="reset_${secIdx}_${idx}"  style="display:none;">Reset</button>
      </div>
      <div class="counter-row">
        <span>Rep: <span class="big-num" id="currRep_${secIdx}_${idx}">0</span>/<span id="maxRep_${secIdx}_${idx}">${ex.defaultReps}</span></span>
        <span>Time: <span class="big-num" id="currSec_${secIdx}_${idx}">0</span>/<span id="maxSec_${secIdx}_${idx}">${ex.defaultSeconds}</span> sec</span>
        <span class="total-time">Total: <span id="totalTime_${secIdx}_${idx}">0:00</span></span>
      </div>
      <div class="progress-txt" id="progressTxt_${secIdx}_${idx}">&nbsp;</div>
    `;
    exContainer.appendChild(exBox);

    let state = {
      running: false, paused: false, finished: false,
      rep: 0, sec: 0, total: 0, interval: null,
      reps: ex.defaultReps, perSec: ex.defaultSeconds,
      firstTime: true,
    };

    const repInp = document.getElementById(`reps_${secIdx}_${idx}`);
    const secInp = document.getElementById(`seconds_${secIdx}_${idx}`);
    const startBtn = document.getElementById(`start_${secIdx}_${idx}`);
    const pauseBtn = document.getElementById(`pause_${secIdx}_${idx}`);
    const resumeBtn = document.getElementById(`resume_${secIdx}_${idx}`);
    const resetBtn = document.getElementById(`reset_${secIdx}_${idx}`);
    const currRep = document.getElementById(`currRep_${secIdx}_${idx}`);
    const maxRep = document.getElementById(`maxRep_${secIdx}_${idx}`);
    const currSec = document.getElementById(`currSec_${secIdx}_${idx}`);
    const maxSec = document.getElementById(`maxSec_${secIdx}_${idx}`);
    const totalTime = document.getElementById(`totalTime_${secIdx}_${idx}`);
    const progressTxt = document.getElementById(`progressTxt_${secIdx}_${idx}`);

    function updateDisplay() {
      currRep.innerText = state.rep;
      maxRep.innerText = state.reps;
      currSec.innerText = state.sec;
      maxSec.innerText = state.perSec;
      totalTime.innerText = formatTime(state.total);
      if(state.finished) {
        progressTxt.innerText = "WELL DONE! Exercise complete.";
        progressTxt.className = "progress-txt danger";
        exBox.classList.remove("active");
      }
      else if(state.rep>=state.reps) {
        progressTxt.innerText = "Completed! Press Reset to repeat.";
        progressTxt.className = "progress-txt warning";
        exBox.classList.remove("active");
      }
      else if(state.running) {
        let left = state.reps - state.rep;
        progressTxt.innerText = left==0 ? "Last rep!" : (left==1 ? "Last one, keep going!" : `Only ${left} left!`);
        progressTxt.className = "progress-txt";
        exBox.classList.add("active");
      } else if(state.paused) {
        progressTxt.innerText = "Paused";
        progressTxt.className = "progress-txt warning";
      } else {
        progressTxt.innerHTML = "&nbsp;";
        progressTxt.className = "progress-txt";
        exBox.classList.remove("active");
      }
    }
    function disableInputs(dis) {
      repInp.disabled = dis;
      secInp.disabled = dis;
    }
    function start() {
      state.reps = parseInt(repInp.value)||1;
      state.perSec = parseInt(secInp.value)||1;
      state.rep = 0; state.sec = 0; state.total=0;
      state.running=true; state.paused=false; state.finished=false;
      if(state.firstTime) {
        playFirstTimeSound();
        state.firstTime = false;
      } else {
        playStartSound();
      }
      disableInputs(true);
      currRep.classList.remove('pulse');
      currSec.classList.remove('pulse');
      updateDisplay();
      startBtn.style.display='none';
      pauseBtn.style.display='';
      resumeBtn.style.display='none';
      resetBtn.style.display='';
      exBox.classList.add("active");
      state.interval = setInterval(() => {
        if(state.paused||state.finished) return;
        state.sec++; state.total++;
        currSec.classList.add('pulse');
        setTimeout(()=>currSec.classList.remove('pulse'),220);
        if(state.sec>=state.perSec) {
          state.sec=0;
          state.rep++;
          currRep.classList.add('pulse');
          setTimeout(()=>currRep.classList.remove('pulse'),200);
          playBeep(2);
          if(state.rep>=state.reps) {
            clearInterval(state.interval); state.interval=null;
            state.running=false; state.finished=true;
            setTimeout(()=>playBeep(7), 350);
          }
        }
        updateDisplay();
      },1000);
    }
    function pause() {
      if(state.running && !state.paused){
        state.paused=true; state.running=false;
        clearInterval(state.interval); state.interval=null;
        pauseBtn.style.display='none'; resumeBtn.style.display='';
        exBox.classList.remove("active");
        updateDisplay();
      }
    }
    function resume() {
      if(state.paused && !state.running){
        state.paused=false; state.running=true;
        pauseBtn.style.display=''; resumeBtn.style.display='none';
        exBox.classList.add("active");
        state.interval = setInterval(() => {
          if(state.paused||state.finished) return;
          state.sec++; state.total++;
          currSec.classList.add('pulse');
          setTimeout(()=>currSec.classList.remove('pulse'),220);
          if(state.sec>=state.perSec) {
            state.sec=0; state.rep++;
            currRep.classList.add('pulse');
            setTimeout(()=>currRep.classList.remove('pulse'),200);
            playBeep(2);
            if(state.rep>=state.reps) {
              clearInterval(state.interval); state.interval=null;
              state.running=false; state.finished=true;
              setTimeout(()=>playBeep(7),350);
            }
          }
          updateDisplay();
        },1000);
        updateDisplay();
      }
    }
    function reset() {
      if(state.interval) {clearInterval(state.interval);}
      state.rep=0; state.sec=0; state.total=0;
      state.running=false; state.paused=false; state.finished=false;
      updateDisplay();
      startBtn.style.display=''; pauseBtn.style.display='none'; resumeBtn.style.display='none'; resetBtn.style.display='none';
      disableInputs(false);
      exBox.classList.remove("active");
    }
    startBtn.onclick = start;
    pauseBtn.onclick = pause;
    resumeBtn.onclick = resume;
    resetBtn.onclick = reset;
    repInp.addEventListener('change', reset);
    secInp.addEventListener('change', reset);
    updateDisplay(); pauseBtn.style.display='none'; resumeBtn.style.display='none'; resetBtn.style.display='none';

    const selCheckbox = document.getElementById(`sel_${secIdx}_${idx}`);
    const controller = {
      secIdx, idx,
      name: ex.name,
      start: ()=> start(),
      pause: ()=> pause(),
      resume: ()=> resume(),
      reset: ()=> reset(),
      state,
      selCheckbox,
    };
    controllers.push(controller);
  });
});

// --- Sequencer Logic ---
function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }
let sequencer = { running:false, paused:false, currentIdx:-1 };
function getSelectedControllers(){ return controllers.filter(c=> c.selCheckbox && c.selCheckbox.checked); }
function updateSeqStatus() {
  const status = document.getElementById('seqStatus');
  if(sequencer.running){
    const list = getSelectedControllers();
    const nextIdx = sequencer.currentIdx + 1;
    const nextName = nextIdx < list.length ? list[nextIdx].name : 'Done';
    status.innerText = `Running... Current: ${sequencer.currentIdx >= 0 ? list[sequencer.currentIdx].name : 'Starting'} | Next: ${nextName}`;
    status.style.display = 'block';
  } else {
    status.style.display = 'none';
  }
}

document.getElementById('selectAllBtn').addEventListener('click', ()=>{
  controllers.forEach(c=> c.selCheckbox && (c.selCheckbox.checked = true));
});
document.getElementById('deselectAllBtn').addEventListener('click', ()=>{
  controllers.forEach(c=> c.selCheckbox && (c.selCheckbox.checked = false));
});

document.getElementById('pauseAllBtn').addEventListener('click', ()=>{
  sequencer.paused = true;
  controllers.forEach(c=> c.pause());
  updateSeqStatus();
});
document.getElementById('resumeAllBtn').addEventListener('click', ()=>{
  sequencer.paused = false;
  controllers.forEach(c=> c.resume());
  updateSeqStatus();
});
document.getElementById('resetAllBtn').addEventListener('click', ()=>{
  sequencer.running = false;
  sequencer.paused = false;
  sequencer.currentIdx = -1;
  controllers.forEach(c=> c.reset());
  updateSeqStatus();
});

document.getElementById('startAllBtn').addEventListener('click', async ()=>{
  if(sequencer.running) return;
  sequencer.running = true;
  sequencer.paused = false;
  const list = getSelectedControllers();
  if(list.length === 0) { alert('No exercises selected!'); return; }
  
  for(let i=0; i<list.length && sequencer.running; i++){
    // wait while paused
    while(sequencer.paused){ await sleep(200); if(!sequencer.running) break; }
    if(!sequencer.running) break;
    
    const c = list[i];
    sequencer.currentIdx = i;
    updateSeqStatus();
    
    c.reset();
    c.start();
    
    // wait for exercise to finish
    while(true){
      if(!sequencer.running) break;
      if(sequencer.paused){ c.pause(); await sleep(200); continue; }
      if(c.state.finished) break;
      await sleep(300);
    }
    if(!sequencer.running) break;
    
    // wait 10 seconds before next exercise
    for(let t=0; t<10 && sequencer.running; t++){
      if(sequencer.paused){ await sleep(200); t--; continue; }
      await sleep(1000);
    }
  }
  
  sequencer.running = false;
  sequencer.currentIdx = -1;
  updateSeqStatus();
});
</script>
</body>
</html>
